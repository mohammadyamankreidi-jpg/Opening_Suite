<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ShiftStart ‚Äì Opslag</title>
  <link rel="icon" href="data:,">
  <style>
    :root{--red:#a31212;--black:#0b0b0f;--panel:rgba(21,25,34,.86);--line:#2a2f3a;--text:#eef2f8;--muted:#9fb0cb}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:linear-gradient(90deg,var(--black) 50%,var(--red) 50%);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:980px;margin:0 auto;padding:28px 18px 40px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:20px;backdrop-filter:blur(6px)}
    header.panel{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;padding:14px 16px;margin-bottom:12px;background:var(--panel);border:1px solid var(--line);border-radius:14px}
    .brand .h{font-weight:800;font-size:18px}.brand .s{color:var(--muted);font-size:12px}
    .tools{display:flex;gap:8px;flex-wrap:wrap}
    button{background:#101624;color:var(--text);border:1px solid var(--line);border-radius:10px;padding:10px 12px;cursor:pointer;font-weight:600}
    .cols{display:flex;flex-direction:column;gap:18px}
    .section{border:1px solid var(--line);border-radius:14px;padding:12px 12px 14px;background:#0f1320}
    .head{font-weight:800;letter-spacing:.4px;margin:0 0 8px}
    .divider{height:1px;background:rgba(255,255,255,.15);margin:8px 0 10px;border-radius:1px}
    .add{display:grid;grid-template-columns:1fr auto;gap:10px;margin:8px 0 4px}
    input[type="text"]{width:100%;padding:12px 14px;border-radius:10px;border:1px solid var(--line);background:#0b0f18;color:var(--text)}
    ul{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:8px;min-height:8px}
    li.item{display:flex;align-items:center;gap:8px;background:#0f1320;border:1px solid #262c39;border-radius:12px;padding:12px 14px}
    li.item.done{opacity:.6;text-decoration:line-through}
    .label{flex:1;cursor:pointer}
    .btn{display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border:1px solid #444;border-radius:6px;background:#151a23;cursor:pointer;opacity:.95}
    li.item.dragging{opacity:.6;outline:1px dashed #6aa0ff}
    .hint{color:var(--muted);font-size:12px;margin:6px 2px 0}
    footer.note{margin-top:12px;color:var(--muted);font-size:12px;text-align:center}
    .nav{display:flex;gap:10px;margin-bottom:12px}.nav a{color:#d8e6ff}

    /* üîê Lock overlay */
    .lock{position:fixed;inset:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;z-index:50}
    .lock .panel{background:#0f1320;border:1px solid #262c39;border-radius:14px;padding:20px;min-width:280px;max-width:90%}
    .lock h1{margin:0 0 10px;font-size:18px}
    .lock .row{display:flex;gap:8px}
    .lock input{flex:1;padding:10px 12px;border-radius:10px;border:1px solid #2a2f3a;background:#0b0f18;color:#eef2f8}
  </style>
</head>
<body>
  <div class="wrap">
    <nav class="nav"><a href="index.html">‚Üê Terug</a></nav>

    <header class="panel card">
      <div class="brand">
        <div class="h">ShiftStart</div>
        <div class="s">Opslag</div>
      </div>
      <div class="tools"></div>
    </header>

    <!-- üîê alles hieronder is verborgen totdat code is ingevoerd -->
    <div id="locked" class="lock" hidden>
      <div class="panel">
        <h1>Toegang vereist</h1>
        <p class="hint">Voer de beheerderscode in om Opslag te openen.</p>
        <div class="row" style="margin-top:8px">
          <input id="codeInput" type="password" placeholder="Beheerderscode" />
          <button id="btnUnlock">Open</button>
        </div>
      </div>
    </div>

    <div id="content" class="card" hidden>
      <div class="add">
        <input id="newItem" type="text" placeholder="Nieuw item (komt in OVERIG)..." />
        <button id="btnAdd">Toevoegen</button>
      </div>

      <div class="cols">
        <section class="section">
          <div class="head">PAPIER & ZAKKEN</div>
          <div class="divider"></div>
          <ul id="list-PAPIER"></ul>
        </section>

        <section class="section">
          <div class="head">BALIE & SERVIES</div>
          <div class="divider"></div>
          <ul id="list-BALIE"></ul>
        </section>

        <section class="section">
          <div class="head">SALADE & CHEEZIN</div>
          <div class="divider"></div>
          <ul id="list-SALADE"></ul>
        </section>

        <section class="section">
          <div class="head">SUNDAE & SHAKE</div>
          <div class="divider"></div>
          <ul id="list-SHAKE"></ul>
        </section>

        <section class="section">
          <div class="head">POEDERS & SIROPEN</div>
          <div class="divider"></div>
          <ul id="list-POEDER"></ul>
        </section>

        <section class="section">
          <div class="head">SAUZEN</div>
          <div class="divider"></div>
          <ul id="list-SAUZEN"></ul>
        </section>

        <section class="section">
          <div class="head">TOPPINGS</div>
          <div class="divider"></div>
          <ul id="list-TOPPING"></ul>
        </section>

        <section class="section">
          <div class="head">DRANKEN</div>
          <div class="divider"></div>
          <ul id="list-DRANK"></ul>
        </section>

        <section class="section">
          <div class="head">KEUKEN</div>
          <div class="divider"></div>
          <ul id="list-KEUKEN"></ul>
        </section>

        <section class="section">
          <div class="head">KINDERMENU & OVERIG</div>
          <div class="divider"></div>
          <ul id="list-OVERIG"></ul>
        </section>
      </div>

      <p class="hint">Klik op de tekst of het vinkje om af te strepen. Alles synct voor iedereen.</p>
    </div>

    <footer class="note">ShiftStart ¬∑ gedeelde opslag via Firebase</footer>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
import { getFirestore, doc, onSnapshot, setDoc, serverTimestamp, updateDoc, deleteField } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
import { firebaseConfig } from "./firebase-config.js?v=15";

/* ===== Firebase ===== */
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

/* ===== Config ===== */
const DOC_ID     = "opslag_lijst";
const ADMIN_CODE = "YamanBS1";

/* ===== Locking ===== */
const LS_KEY_UNLOCK = "ops_unlocked";
const lockedEl  = document.getElementById("locked");
const contentEl = document.getElementById("content");
const codeInput = document.getElementById("codeInput");
const btnUnlock = document.getElementById("btnUnlock");

function updateLockUI(){
  const unlocked = localStorage.getItem(LS_KEY_UNLOCK)==="1";
  lockedEl.hidden  = unlocked;
  contentEl.hidden = !unlocked;
}
btnUnlock.onclick = ()=>{
  if (codeInput.value.trim()===ADMIN_CODE){
    localStorage.setItem(LS_KEY_UNLOCK,"1");
    updateLockUI();
    // zet ook edit-modus meteen aan
    localStorage.setItem("editMode","1");
    canEdit = true;
    updateTools();
    render();
  } else {
    alert("Onjuiste code.");
  }
};
window.addEventListener("storage", e=>{
  if (e.key===LS_KEY_UNLOCK){ updateLockUI(); }
  if (e.key==="editMode"){ canEdit=(localStorage.getItem("editMode")==="1"); updateTools(); render(); }
});
updateLockUI();

/* ===== Toolbar ===== */
let tools = document.querySelector(".tools");
const bEdit  = document.createElement("button"); bEdit.type="button";  bEdit.textContent  = "üîì Bewerk-modus";
const bView  = document.createElement("button"); bView.type="button";  bView.textContent  = "üîí Alleen afvinken";
const bReset = document.createElement("button"); bReset.type="button"; bReset.textContent = "Alles herstellen";
const bSeed  = document.createElement("button"); bSeed.type="button";  bSeed.textContent  = "Herstel lijst";
const bLock  = document.createElement("button"); bLock.type="button";  bLock.textContent  = "üîê Vergrendel";
tools.replaceChildren(bEdit,bView,bReset,bSeed,bLock);

let canEdit = (localStorage.getItem("editMode")==="1");
function updateTools(){
  const unlocked = localStorage.getItem(LS_KEY_UNLOCK)==="1";
  [bEdit,bView,bReset,bSeed].forEach(b=>b.disabled=!unlocked);
  bLock.disabled = !unlocked;
}
bEdit.onclick = ()=>{ localStorage.setItem("editMode","1"); canEdit=true; updateTools(); render(); alert("Bewerk-modus aan ‚úÖ"); };
bView.onclick = ()=>{ localStorage.removeItem("editMode"); canEdit=false; updateTools(); render(); alert("Alleen afvinken üîí"); };
bReset.onclick = ()=>{ const next=Object.fromEntries(Object.keys(items).map(k=>[k,false])); items=next; save({items:next}); };
bSeed.onclick  = async ()=>{ if(!canEdit) return; if(!confirm("Herstel naar begin-lijst? (Iedereen ziet dit)")) return; await hardSeed(); };
bLock.onclick  = ()=>{ localStorage.removeItem(LS_KEY_UNLOCK); localStorage.removeItem("editMode"); canEdit=false; updateLockUI(); updateTools(); };

/* ===== UI refs ===== */
const elNew = document.getElementById("newItem");
const btnAdd= document.getElementById("btnAdd");
const lists = {
  "PAPIER":  document.getElementById("list-PAPIER"),
  "BALIE":   document.getElementById("list-BALIE"),
  "SALADE":  document.getElementById("list-SALADE"),
  "SHAKE":   document.getElementById("list-SHAKE"),
  "POEDER":  document.getElementById("list-POEDER"),
  "SAUZEN":  document.getElementById("list-SAUZEN"),
  "TOPPING": document.getElementById("list-TOPPING"),
  "DRANK":   document.getElementById("list-DRANK"),
  "KEUKEN":  document.getElementById("list-KEUKEN"),
  "OVERIG":  document.getElementById("list-OVERIG"),
};

/* ===== Seed + categorie-indeling ===== */
function getSeed(){
  const cats = {
    "PAPIER": [
      "Inpakpapier","Junior papier","Dresspapier",
      "Inpakkzakken groot","Inpakzakken medium","Inpakzakken klein",
      "Servetten","Tork"
    ],
    "BALIE":  [
      "Rietjes","Houdertjes 2&4"
    ],
    "SALADE": [
      "Saladedeksel en Saladebakken 500&1000mm",
      "Cheezin bakjes","Cheezin vorkjes"
    ],
    "SHAKE": [
      "Sundae lepels","Sundae bekers","Sundae deksels","Shuffel lepels",
      "Milkshake bekers 500","Milkshake bekers 400","Milkshake bekers 300","Milkshake deksels"
    ],
    "POEDER": [
      "Matcha & ice coffee","Popping&siropen","Kleine sauzen bakjes"
    ],
    "SAUZEN": [
      "Pi√±ata","Jalape√±os","Honeymosterd","Caesar","Yoghurt"
    ],
    "TOPPING": [
      "Aardbei topping","Chocolate topping","Kinderbueno topping"
    ],
    "DRANK": [
      "Cola","Cola zero","Fanta","Fanta zero","Sprite",
      "Fernandez groen","Fernandez rood",
      "Ice tea sparkling","Ice tea peach","Ice tea green",
      "Chocomel","Fristi","Cassis","Appelsap","Sinaasappelsap",
      "Caprisun","Water","Chocomel pakjes","Fristi pakjes"
    ],
    "KEUKEN": ["Levo vet"],
    "OVERIG": ["Kinderspeelgoed"]
  };

  // items (checkbox state)
  const items = {};
  Object.values(cats).flat().forEach(k => items[k]=false);

  // order per categorie (voor drag)
  const orderPerCat = {};
  Object.keys(cats).forEach(cat => orderPerCat[cat] = cats[cat].slice());

  return { items, orderPerCat };
}

/* ===== State + realtime ===== */
let items = {};
let orderPerCat = {}; // {CAT: [labels...]}

onSnapshot(doc(db,"lists",DOC_ID), async snap=>{
  if (snap.exists()){
    const d = snap.data();
    items      = d.items || {};
    orderPerCat= d.orderPerCat || {};
  } else {
    await hardSeed();
  }
  render();
});

/* ===== Persist helpers ===== */
async function save(p){
  await setDoc(doc(db,"lists",DOC_ID), { ...(p||{}), updatedAt: serverTimestamp() }, { merge:true });
}
async function hardSeed(){
  const s = getSeed();
  items = s.items; orderPerCat = s.orderPerCat;
  await setDoc(doc(db,"lists",DOC_ID), { items, orderPerCat, updatedAt: serverTimestamp() }, { merge:false });
}

/* ===== Small helpers ===== */
function makeBtn(txt,title,onClick){
  const b=document.createElement("button");
  b.className="btn"; b.textContent=txt; b.title=title; b.type="button";
  b.addEventListener("click",(e)=>{ e.preventDefault(); e.stopPropagation(); if (e.stopImmediatePropagation) e.stopImmediatePropagation(); onClick(); },{capture:true});
  return b;
}
function catOf(label){
  // zoek huidige categorie waarin dit label staat; anders OVERIG
  for (const [cat, arr] of Object.entries(orderPerCat)){
    if (Array.isArray(arr) && arr.includes(label)) return cat;
  }
  return "OVERIG";
}

/* ===== Render ===== */
function render(){
  // leeg alle ULs
  Object.values(lists).forEach(ul=> ul.innerHTML="");

  const unlocked = localStorage.getItem(LS_KEY_UNLOCK)==="1";
  // per categorie in de bewaarde volgorde
  for (const [cat, ul] of Object.entries(lists)){
    const keys = (orderPerCat[cat] || []).filter(k => k in items);
    keys.forEach((k,idx)=>{
      const li=document.createElement("li");
      li.className="item"+(items[k]?" done":"");
      li.dataset.cat = cat;
      li.dataset.index = String(idx);

      const cb = document.createElement("input");
      cb.type="checkbox"; cb.checked=!!items[k];
      cb.onchange = ()=> toggle(k);

      const label = document.createElement("div");
      label.className="label"; label.textContent = k;
      if(!canEdit) label.onclick=()=>toggle(k);

      if (canEdit){
        const pen=makeBtn("‚úèÔ∏è","Naam aanpassen",()=>renameItem(k));
        const del=makeBtn("üóëÔ∏è","Verwijderen",()=>removeItemConfirm(k));

        // drag binnen/buiten categorie
        li.draggable = true;
        li.addEventListener("dragstart", e=>{
          li.classList.add("dragging");
          e.dataTransfer.setData("text/plain", JSON.stringify({ fromCat: cat, fromIdx: idx, label: k }));
        });
        li.addEventListener("dragend", ()=> li.classList.remove("dragging"));
        ul.addEventListener("dragover", e=> e.preventDefault());
        ul.addEventListener("drop", e=>{
          e.preventDefault();
          const data = JSON.parse(e.dataTransfer.getData("text/plain")||"{}");
          const toCat = cat;
          if (!data || !data.label) return;
          const fromArr = orderPerCat[data.fromCat] || [];
          const toArr   = orderPerCat[toCat] || [];
          // haal uit oude
          const i = fromArr.indexOf(data.label);
          if (i>-1) fromArr.splice(i,1);
          // voeg op eind toe in nieuwe (simpel); of op positie idx:
          const toIndex = Number(li.dataset.index);
          if (Number.isFinite(toIndex)){
            toArr.splice(toIndex,0,data.label);
          } else {
            toArr.push(data.label);
          }
          orderPerCat[data.fromCat] = fromArr;
          orderPerCat[toCat]       = toArr;
          save({ orderPerCat });
          render();
        });

        li.append(cb,label,pen,del);
      } else {
        li.append(cb,label);
      }
      ul.appendChild(li);
    });
  }

  // UI toestanden
  elNew.disabled = btnAdd.disabled = !unlocked || !canEdit;
  updateTools();
}

/* ===== Actions ===== */
function toggle(k){
  const next={...items,[k]:!items[k]};
  items=next;
  save({items:next});
}
function addItem(t){
  const x=(t||"").trim(); if(!x) return;
  if(x in items){ alert("Bestaat al."); return; }
  items = { ...items, [x]: false };
  // nieuwe items komen in OVERIG onderaan
  orderPerCat.OVERIG = Array.isArray(orderPerCat.OVERIG) ? orderPerCat.OVERIG.concat(x) : [x];
  render(); save({ items, orderPerCat });
}
async function removeItemConfirm(k){
  if(!(k in items)) return;
  if(!confirm(`Verwijder "${k}"?`)) return;
  // lokaal
  const c = catOf(k);
  const nextItems={...items}; delete nextItems[k];
  const nextCatOrder=(orderPerCat[c]||[]).filter(x=>x!==k);
  items=nextItems; orderPerCat[c]=nextCatOrder;
  render();
  // remote
  await updateDoc(doc(db,"lists",DOC_ID),{
    [`items.${k}`]: deleteField(),
    orderPerCat: orderPerCat,
    updatedAt: serverTimestamp()
  });
}
async function renameItem(oldK){
  if(!(oldK in items)) return;
  const s = prompt("Nieuwe naam:", oldK);
  if (s===null) return;
  const n = (s||"").trim();
  if(!n) return;
  if(n===oldK) return;

  const cOld = catOf(oldK);
  const exists = (n in items);
  const merged = !!items[oldK] || !!items[n];

  // lokaal
  let ni={...items};
  delete ni[oldK];
  ni[n]=merged;

  // order bijwerken (in dezelfde categorie)
  let arr = (orderPerCat[cOld]||[]).slice();
  if (exists){
    // verwijder oude positie, laat bestaande n staan (positie van n blijft)
    arr = arr.filter(x=>x!==oldK);
  } else {
    arr = arr.map(x=>x===oldK?n:x);
  }
  items=ni; orderPerCat[cOld]=arr;
  render();

  // remote
  await updateDoc(doc(db,"lists",DOC_ID),{
    [`items.${oldK}`]: deleteField(),
    [`items.${n}`]: merged,
    orderPerCat,
    updatedAt: serverTimestamp()
  });
}

/* ===== Events ===== */
btnAdd.onclick = ()=>{ addItem(elNew.value); elNew.value=""; elNew.focus(); };
elNew.addEventListener("keydown", e=>{ if(e.key==="Enter"){ e.preventDefault(); addItem(elNew.value); elNew.value=""; }});

</script>
</body>
</html>
