<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ShiftStart ‚Äì Prioriteit</title>
  <link rel="icon" href="data:,">
  <style>
    :root{--red:#a31212;--black:#0b0b0f;--panel:rgba(21,25,34,.86);--line:#2a2f3a;--text:#eef2f8;--muted:#9fb0cb}
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0;
      background:linear-gradient(90deg,var(--black) 50%,var(--red) 50%);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    }
    .wrap{max-width:980px;margin:0 auto;padding:28px 18px 40px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:20px;backdrop-filter:blur(6px)}
    header.panel{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;padding:14px 16px;margin-bottom:12px;background:var(--panel);border:1px solid var(--line);border-radius:14px}
    .brand{display:flex;flex-direction:column;gap:2px}.brand .h{font-weight:800;font-size:18px}.brand .s{color:var(--muted);font-size:12px}

    .header-right{display:flex;align-items:center;gap:8px}

    /* tools standaard verborgen ‚Äì alleen in Back Office + edit */
    .tools{display:none;gap:8px;flex-wrap:wrap}

    button{background:#101624;color:var(--text);border:1px solid var(--line);border-radius:10px;padding:10px 12px;cursor:pointer;font-weight:600}

    .cols{display:flex;flex-direction:column;gap:18px}
    .section{border:1px solid var(--line);border-radius:14px;padding:12px 12px 14px;background:#0f1320}
    .head{font-weight:800;letter-spacing:.4px;margin:0 0 8px;text-transform:uppercase}
    .divider{height:1px;background:rgba(255,255,255,.15);margin:8px 0 10px;border-radius:1px}

    .add{display:grid;grid-template-columns:1fr auto;gap:10px;margin:8px 0 4px}
    input[type="text"]{width:100%;padding:12px 14px;border-radius:10px;border:1px solid var(--line);background:#0b0f18;color:var(--text)}

    ul{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:8px;min-height:8px}
    li.item{display:flex;align-items:center;gap:8px;background:#0f1320;border:1px solid #262c39;border-radius:12px;padding:12px 14px;cursor:grab}
    li.item.done{opacity:.6;text-decoration:line-through}
    li.item.dragging{opacity:.5;outline:1px dashed #6aa0ff;cursor:grabbing}

    .label{flex:1;cursor:pointer}
    .btn{display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border:1px solid #444;border-radius:6px;background:#151a23;cursor:pointer;opacity:.95}

    .nav{display:flex;gap:10px;margin-bottom:12px}.nav a{color:#d8e6ff}
    .hint{color:var(--muted);font-size:12px;margin:6px 2px 0}
    footer.note{margin-top:12px;color:var(--muted);font-size:12px;text-align:center}

    /* Back Office code overlay */
    .lock{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.7);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:50;
    }
    .lock .panel{
      background:#0f1320;
      border:1px solid #262c39;
      border-radius:14px;
      padding:20px;
      min-width:260px;
      max-width:90%;
    }
    .lock h1{margin:0 0 10px;font-size:18px}
    .lock .row{display:flex;gap:8px;margin-top:8px}
    .lock input{
      flex:1;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid #2a2f3a;
      background:#0b0f18;
      color:#eef2f8;
    }

    /* Notities onderaan ‚Äì statisch */
    .notes{
      margin-top:14px;
      background:#0f1320;
      border:1px solid #262c39;
      border-radius:12px;
      padding:12px 14px;
    }
    .notes .h{font-weight:800;margin-bottom:6px}
    .notes .row{opacity:.9}
    .notes .divider{height:1px;background:#2a2f3a;margin:10px 0;border-radius:1px}
    .notes .em{font-weight:700;margin-bottom:4px}
  </style>
</head>
<body>
  <div class="wrap">
    <nav class="nav"><a href="index.html">‚Üê Terug</a></nav>

    <header class="panel card">
      <div class="brand">
        <div class="h">ShiftStart</div>
        <div class="s">Prioriteit</div>
      </div>
      <div class="header-right">
        <button id="btnBackoffice" type="button">Back Office</button>
        <button id="btnResetAll" type="button">Alles herstellen</button>
        <div class="tools"></div>
      </div>
    </header>

    <div class="card">
      <div class="add">
        <input id="newItem" type="text" placeholder="Nieuw item toevoegen..." />
        <button id="btnAdd">Toevoegen</button>
      </div>

      <div class="cols">
        <section class="section">
          <div class="head">DOORDEWEEKS</div>
          <div class="divider"></div>
          <ul id="list-normal"></ul>
        </section>

        <section class="section">
          <div class="head">WEEKEND</div>
          <div class="divider"></div>
          <ul id="list-weekend"></ul>
        </section>
      </div>

      <p class="hint">Klik op de tekst of het vinkje om af te strepen. In Back Office kun je bewerken, slepen en herstellen.</p>
    </div>

    <!-- Statische notities, niet in Firestore -->
    <div class="notes">
      <div class="h">Aantal brood</div>

      <div class="section">
        <div class="em">Aantal brood (doordeweeks)</div>
        <div class="row">5/6 zakken 12 CM</div>
        <div class="row">1/2 zak 10 CM</div>
        <div class="row">1/2 zak DD</div>
      </div>

      <div class="divider"></div>

      <div class="section">
        <div class="em">Weekend</div>
        <div class="row">6/7 zakken 12 CM</div>
        <div class="row">1/2 zak 10 CM</div>
        <div class="row">1/2 zakken DD</div>
      </div>

      <div class="divider"></div>

      <div class="section">
        <div class="em">Bacon</div>
        <div class="row">Bacon altijd 1 op voorraad in de koelkast houden, en √©√©n voor in de bak.</div>
      </div>
    </div>

    <footer class="note">ShiftStart ¬∑ gedeelde opslag via Firebase</footer>
  </div>

  <!-- Back Office code dialoog (code met sterretjes) -->
  <div id="boDialog" class="lock">
    <div class="panel">
      <h1>Back Office</h1>
      <p class="hint">Voer de beheerderscode in om bewerk-modus te openen.</p>
      <div class="row">
        <input id="boCodeInput" type="password" placeholder="Beheerderscode" />
        <button id="boConfirm" type="button">Open</button>
      </div>
    </div>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
import { getFirestore, doc, onSnapshot, setDoc, serverTimestamp, updateDoc, deleteField } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
import { firebaseConfig } from "./firebase-config.js?v=15";

/* ===== Firebase ===== */
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

/* ===== Config ===== */
const DOC_ID     = "prioriteit_lijst";
const ADMIN_CODE = "YamanBS1";

/* ===== UI refs ===== */
const toolsBar      = document.querySelector(".tools");
const btnBackoffice = document.getElementById("btnBackoffice");
const btnResetAll   = document.getElementById("btnResetAll");

const elNew   = document.getElementById("newItem");
const btnAdd  = document.getElementById("btnAdd");
const ulNorm  = document.getElementById("list-normal");
const ulWknd  = document.getElementById("list-weekend");

/* Backoffice dialog */
const boDialog   = document.getElementById("boDialog");
const boCodeInput= document.getElementById("boCodeInput");
const boConfirm  = document.getElementById("boConfirm");

/* ===== Toolbar-knoppen (alleen in Back Office + edit) ===== */
const bSeed = document.createElement("button"); bSeed.textContent = "Herstel lijst";
const bView = document.createElement("button"); bView.textContent = "Alleen afvinken";
toolsBar.replaceChildren(bSeed, bView);

/* ===== State ===== */
let backUnlocked = false; // alleen geldig tijdens deze pagina
let canEdit      = false; // of we nu in bewerk-modus zijn

let items       = {};     // { label: bool }
let normalOrder = [];     // [ label, ... ]
let weekendOrder= [];     // [ label, ... ]

/* ===== Seed (items + twee lijsten) ===== */
function getSeed(){
  const normal = [
    "15:15 Afzuiging aan",
    "15:15 Fietsen buiten en dweilen",
    "15:20 PC aan",
    "15:20 brood/ bacon uithalen (check aantal onderaan de pagina)",
    "15:25 Dresstafel klaarmaken",
    "15:25 Bin aan inclusief verwarming aan de achterkant",
    "15:30 Grill aan",
    "15:40 Broodtoaster aan",
    "15:50 Friteuse 1/3 aan",
    "15:50 Kassatellen",
    "15:55 Tv‚Äôs aanzetten",
    "16:00 Friteuse 2/4 aan",
    "16:00 Wraps toaster aan op 50 graden",
    "16:00 Bord omdraaien naar geopend!"
  ];

  const weekend = [
    "15:15 Afzuiging aan (weekend)",
    "15:15 Fietsen buiten en dweilen (weekend)",
    "15:20 PC aan (weekend)",
    "15:20 brood/ bacon uithalen (weekend)",
    "15:20 Grill aan (weekend)",
    "15:25 Dresstafel klaarmaken (weekend)",
    "15:25 Bin aan inclusief verwarming aan de achterkant (weekend)",
    "15:30 Broodtoaster aan (weekend)",
    "15:35 Friteuse 1/3 aan (weekend)",
    "15:50 Kassatellen (weekend)",
    "15:55 Tv‚Äôs aanzetten (weekend)",
    "16:00 Friteuse 2/4 aan (weekend)",
    "16:00 Wraps toaster aan op 50 (weekend)",
    "16:00 Bord omdraaien naar geopend! (weekend)"
  ];

  const allItems = {};
  normal.forEach(k => allItems[k] = false);
  weekend.forEach(k => allItems[k] = false);

  return {
    items: allItems,
    normalOrder: normal,
    weekendOrder: weekend
  };
}

/* ===== helpers for Firestore ===== */
async function save(patch){
  await setDoc(doc(db,"lists",DOC_ID), { ...(patch||{}), updatedAt: serverTimestamp() }, { merge:true });
}
async function hardSeed(){
  const s = getSeed();
  items        = s.items;
  normalOrder  = s.normalOrder;
  weekendOrder = s.weekendOrder;
  await setDoc(doc(db,"lists",DOC_ID), {
    items,
    normalOrder,
    weekendOrder,
    updatedAt: serverTimestamp()
  }, { merge:false });
}

/* ===== group helper ===== */
function groupOf(label){
  if (Array.isArray(normalOrder) && normalOrder.includes(label)) return "NORMAL";
  if (Array.isArray(weekendOrder) && weekendOrder.includes(label)) return "WEEKEND";
  return null;
}

/* ===== Back Office UI ===== */
function updateToolsVisible(){
  toolsBar.style.display = (backUnlocked && canEdit) ? "flex" : "none";
}
function updateUI(){
  const canType = backUnlocked && canEdit;
  [elNew, btnAdd].forEach(el=>{
    if (!el) return;
    el.disabled = !canType;
    el.style.opacity = canType ? 1 : 0.6;
    el.style.pointerEvents = canType ? "auto" : "none";
  });
}

/* dialoog open/close */
function openBoDialog(){
  boDialog.style.display = "flex";
  boCodeInput.value = "";
  setTimeout(()=>boCodeInput.focus(), 0);
}
function closeBoDialog(){
  boDialog.style.display = "none";
}

btnBackoffice.onclick = () => {
  openBoDialog();
};

boConfirm.onclick = () => {
  const val = (boCodeInput.value || "").trim();
  if (val === ADMIN_CODE){
    backUnlocked = true;
    canEdit      = true;
    closeBoDialog();
    updateToolsVisible();
    updateUI();
    render();
    alert("Back Office geopend ‚úÖ");
  } else {
    alert("Onjuiste code");
  }
};

boCodeInput.addEventListener("keydown", e=>{
  if (e.key === "Enter"){
    e.preventDefault();
    boConfirm.click();
  }
});

/* ===== ‚ÄúAlles herstellen‚Äù ‚Äì altijd zichtbaar ===== */
btnResetAll.onclick = () => {
  const next = {};
  Object.keys(items).forEach(k => next[k] = false);
  items = next;
  save({ items: next });
  render();
};

/* ===== Toolbar acties (alleen in Back Office + edit) ===== */
bView.onclick = () => {
  canEdit = false;
  updateToolsVisible();
  updateUI();
  render();
  alert("Alleen afvinken üîí");
};

bSeed.onclick = async () => {
  if (!backUnlocked || !canEdit) return;
  if (!confirm("Herstel naar begin-lijst? (Iedereen ziet dit)")) return;
  await hardSeed();
  render();
};

/* ===== Firestore sync ===== */
onSnapshot(doc(db,"lists",DOC_ID), async snap=>{
  if (snap.exists()){
    const d = snap.data();
    items        = d.items || {};
    normalOrder  = Array.isArray(d.normalOrder)  ? d.normalOrder  : [];
    weekendOrder = Array.isArray(d.weekendOrder) ? d.weekendOrder : [];
  } else {
    await hardSeed();
  }
  render();
});

/* ===== UI helpers ===== */
function makeIconButton(txt,title,onClick){
  const b=document.createElement("button");
  b.className="btn";
  b.textContent=txt;
  b.title=title;
  b.type="button";
  b.addEventListener("click",(e)=>{
    e.preventDefault();
    e.stopPropagation();
    onClick();
  },{capture:true});
  return b;
}

/* ===== Render ===== */
function render(){
  ulNorm.innerHTML = "";
  ulWknd.innerHTML = "";

  const normKeys = (normalOrder || []).filter(k => k in items);
  const wkndKeys = (weekendOrder || []).filter(k => k in items);

  const renderList = (keys, target, groupName)=>{
    keys.forEach((k,idx)=>{
      if (!(k in items)) return;
      const li=document.createElement("li");
      li.className="item"+(items[k]?" done":"");
      li.dataset.index = String(idx);
      li.dataset.group = groupName;

      const cb=document.createElement("input");
      cb.type="checkbox";
      cb.checked=!!items[k];
      cb.onchange=()=>toggle(k);

      const span=document.createElement("div");
      span.className="label";
      span.textContent=k;
      if (!canEdit) span.onclick=()=>toggle(k);

      if (backUnlocked && canEdit){
        li.draggable=true;
        li.addEventListener("dragstart", e=>{
          li.classList.add("dragging");
          e.dataTransfer.setData("text/plain", JSON.stringify({ group:groupName, from:idx }));
        });
        li.addEventListener("dragend", ()=>li.classList.remove("dragging"));
        li.addEventListener("dragover", e=>e.preventDefault());
        li.addEventListener("drop", e=>{
          e.preventDefault();
          const data = JSON.parse(e.dataTransfer.getData("text/plain")||"{}");
          if (!data || data.group!==groupName) return;
          const from = data.from;
          const to   = Number(li.dataset.index);
          if (!Number.isFinite(from) || !Number.isFinite(to) || from===to) return;

          let arr = groupName==="NORMAL" ? normalOrder.slice() : weekendOrder.slice();
          const [moved] = arr.splice(from,1);
          arr.splice(to,0,moved);
          if (groupName==="NORMAL") normalOrder = arr;
          else weekendOrder = arr;
          save({ normalOrder, weekendOrder });
          render();
        });

        const pen = makeIconButton("‚úèÔ∏è","Naam aanpassen",()=>renameItem(k));
        const del = makeIconButton("üóëÔ∏è","Verwijderen",()=>removeItemConfirm(k));
        li.append(cb,span,pen,del);
      } else {
        li.append(cb,span);
      }

      target.appendChild(li);
    });
  };

  renderList(normKeys, ulNorm, "NORMAL");
  renderList(wkndKeys, ulWknd, "WEEKEND");

  updateToolsVisible();
  updateUI();
}

/* ===== Basis-acties ===== */
function toggle(k){
  const next = { ...items, [k]: !items[k] };
  items = next;
  save({ items: next });
}

btnAdd.onclick = ()=>{
  if (!backUnlocked || !canEdit) return;
  const x = (elNew.value || "").trim();
  if (!x) return;
  if (items[x]){ alert("Bestaat al."); return; }

  // standaard in DOORDEWEEKS
  items[x] = false;
  if (!Array.isArray(normalOrder)) normalOrder = [];
  normalOrder.push(x);

  elNew.value = "";
  elNew.focus();

  save({ items, normalOrder });
  render();
};

elNew.addEventListener("keydown", e=>{
  if (e.key === "Enter"){
    e.preventDefault();
    btnAdd.click();
  }
});

async function removeItemConfirm(k){
  if (!backUnlocked || !canEdit) return;
  if (!(k in items)) return;
  if (!confirm(`Verwijder "${k}"?`)) return;

  const grp = groupOf(k);
  delete items[k];

  if (grp === "NORMAL"){
    normalOrder = (normalOrder || []).filter(x=>x!==k);
  } else if (grp === "WEEKEND"){
    weekendOrder = (weekendOrder || []).filter(x=>x!==k);
  }

  await updateDoc(doc(db,"lists",DOC_ID),{
    [`items.${k}`]: deleteField(),
    normalOrder,
    weekendOrder,
    updatedAt: serverTimestamp()
  });
  render();
}

async function renameItem(oldK){
  if (!backUnlocked || !canEdit || !(oldK in items)) return;
  const s = prompt("Nieuwe naam:", oldK);
  if (s===null) return;
  const n = (s || "").trim();
  if (!n || n === oldK) return;
  if (items[n]){ alert("Naam bestaat al."); return; }

  const grp = groupOf(oldK);

  const value = items[oldK];
  delete items[oldK];
  items[n] = value;

  if (grp === "NORMAL"){
    normalOrder = (normalOrder || []).map(x=>x===oldK?n:x);
  } else if (grp === "WEEKEND"){
    weekendOrder = (weekendOrder || []).map(x=>x===oldK?n:x);
  }

  await updateDoc(doc(db,"lists",DOC_ID),{
    [`items.${oldK}`]: deleteField(),
    [`items.${n}`]: value,
    normalOrder,
    weekendOrder,
    updatedAt: serverTimestamp()
  });
  render();
}
</script>
</body>
</html>
