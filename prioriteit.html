<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ShiftStart ‚Äì Prioriteit</title>
  <link rel="icon" href="data:,">
  <style>
    :root{--red:#a31212;--black:#0b0b0f;--panel:rgba(21,25,34,.86);--line:#2a2f3a;--text:#eef2f8;--muted:#9fb0cb}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:linear-gradient(90deg,var(--black) 50%,var(--red) 50%);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:980px;margin:0 auto;padding:28px 18px 40px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:20px;backdrop-filter:blur(6px)}
    header.panel{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;padding:14px 16px;margin-bottom:12px;background:var(--panel);border:1px solid var(--line);border-radius:14px}
    .brand{display:flex;flex-direction:column;gap:2px}.brand .h{font-weight:800;font-size:18px}.brand .s{color:var(--muted);font-size:12px}
    .tools{display:flex;gap:8px;flex-wrap:wrap}
    button{background:#101624;color:var(--text);border:1px solid var(--line);border-radius:10px;padding:10px 12px;cursor:pointer;font-weight:600}
    .add{display:grid;grid-template-columns:1fr auto;gap:10px;margin:8px 0 4px}
    input[type="text"]{width:100%;padding:12px 14px;border-radius:10px;border:1px solid var(--line);background:#0b0f18;color:var(--text)}
    ul{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:8px}
    li.item{display:flex;align-items:center;gap:8px;background:#0f1320;border:1px solid #262c39;border-radius:12px;padding:12px 14px}
    li.item.done{opacity:.6;text-decoration:line-through}
    .label{flex:1;cursor:pointer}
    .btn{display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border:1px solid #444;border-radius:6px;background:#151a23;cursor:pointer;opacity:.95}
    li.item.dragging{opacity:.6;outline:1px dashed #6aa0ff}
    .nav{display:flex;gap:10px;margin-bottom:12px}.nav a{color:#d8e6ff}
    .hint{color:var(--muted);font-size:12px;margin:6px 2px 0}
    footer.note{margin-top:12px;color:var(--muted);font-size:12px;text-align:center}
    .divider{height:1px;background:#2a2f3a;margin:12px 0}
    .wk-head{font-weight:800;opacity:.95;margin:-2px 0 8px}
    .notes{margin-top:14px;background:#0f1320;border:1px solid #262c39;border-radius:12px;padding:12px 14px}
    .notes .h{font-weight:800;margin-bottom:6px}
    .notes .row{opacity:.9}
  </style>
</head>
<body>
  <div class="wrap">
    <nav class="nav"><a href="index.html">‚Üê Terug</a></nav>

    <header class="panel card">
      <div class="brand"><div class="h">ShiftStart</div><div class="s">Prioriteit</div></div>
      <div class="tools"></div>
    </header>

    <div class="card">
      <div class="add">
        <input id="newItem" type="text" placeholder="Nieuw item toevoegen..." />
        <button id="btnAdd">Toevoegen</button>
      </div>

      <!-- lijsten -->
      <ul id="list-day"></ul>
      <div id="wk-divider" class="divider" style="display:none"></div>
      <div id="wk-head" class="wk-head" style="display:none">WEEKEND</div>
      <ul id="list-weekend"></ul>

      <!-- vaste notities onderaan (niet in Firestore) -->
      <div class="notes">
        <div class="h">Aantal brood</div>
        <div class="row">5/6 zakken 12CM</div>
        <div class="row">1/2 zak 10 CM</div>
        <div class="row">1/2 zak DD</div>
        <div class="divider" style="margin:10px 0"></div>
        <div class="h">Weekend (brood)</div>
        <div class="row">6/7 zakken 12CM</div>
        <div class="row">1/2 zak 10 CM</div>
        <div class="row">1/2 zakken DD</div>
        <div class="divider" style="margin:10px 0"></div>
        <div class="row"><em>Bacon altijd 1 op voorraad in de koelkast houden, en √©√©n voor in de bak.</em></div>
      </div>

      <p class="hint">Klik op de tekst of het vinkje om af te strepen. Synchroniseert voor iedereen.</p>
    </div>

    <footer class="note">ShiftStart ¬∑ gedeelde opslag via Firebase</footer>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
import { getFirestore, doc, onSnapshot, setDoc, serverTimestamp, updateDoc, deleteField } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
import { firebaseConfig } from "./firebase-config.js?v=15";

/* ===== Firebase ===== */
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

/* ===== Config ===== */
const DOC_ID     = "shiftstart_prioriteit";
const ADMIN_CODE = "YamanBS1";

/* ===== UI refs ===== */
const ulDay     = document.getElementById("list-day");
const ulWeekend = document.getElementById("list-weekend");
const wkDivider = document.getElementById("wk-divider");
const wkHead    = document.getElementById("wk-head");
const elNew     = document.getElementById("newItem");
const btnAdd    = document.getElementById("btnAdd");

/* ===== Toolbar / slot ===== */
let toolsBar = document.querySelector(".tools");
if (!toolsBar) {
  toolsBar = document.createElement("div");
  toolsBar.className = "tools";
  (document.querySelector("header.panel") || document.body).appendChild(toolsBar);
}
const btnEdit  = document.createElement("button"); btnEdit.textContent  = "üîì Bewerk-modus"; btnEdit.type="button";
const btnView  = document.createElement("button"); btnView.textContent  = "üîí Alleen afvinken"; btnView.type="button";
const btnReset = document.createElement("button"); btnReset.textContent = "Alles herstellen"; btnReset.type="button";
const btnSeed  = document.createElement("button"); btnSeed.textContent  = "Herstel lijst";   btnSeed.type="button";
toolsBar.replaceChildren(btnEdit, btnView, btnReset, btnSeed);

let canEdit = (localStorage.getItem("editMode")==="1");
btnEdit.onclick = () => {
  const code = prompt("Beheerderscode:");
  if (code === ADMIN_CODE) { canEdit = true; localStorage.setItem("editMode","1"); updateUI(); render(); alert("Bewerk-modus aan ‚úÖ"); }
  else alert("Onjuiste code");
};
btnView.onclick = () => { canEdit = false; localStorage.removeItem("editMode"); updateUI(); render(); alert("Alleen afvinken üîí"); };
window.addEventListener("storage", (e)=>{ if(e.key==="editMode"){ canEdit=(localStorage.getItem("editMode")==="1"); updateUI(); render(); }});

/* ===== Seed (dag + weekend) ===== */
function getSeed(){
  const items = {
    // Dag
    "15:15 Afzuiging aan": false,
    "15:15 Fietsen buiten en Dweilen": false,
    "15:20 PC aan": false,
    "15:20 brood/ bacon uithalen (check aantal onderaan de pagina)": false,
    "15:25 Dresstafel klaarmaken": false,
    "15:25 Bin aan inclusief verwarming aan de achterkant": false,
    "15:30 Grill aan": false,
    "15:40 Broodtoaster aan": false,
    "15:50 Friteuse 1/3 aan": false,
    "15:50 Kassatellen": false,
    "15:55 Tv‚Äôs aanzetten": false,
    "16:00 Friteuse 2/4 aan": false,
    "16:00 Wraps Toaster aan op 50 graden": false,
    "16:00 Bord omdraaien naar geopend!": false,
    // Weekend
    "15:15 Afzuiging aan (weekend)": false,
    "15:15 Fietsen buiten en Dweilen (weekend)": false,
    "15:20 PC aan (weekend)": false,
    "15:20 brood/ bacon uithalen (weekend)": false,
    "15:20 Grill aan (weekend)": false,
    "15:25 Dresstafel klaarmaken (weekend)": false,
    "15:25 Bin aan inclusief verwarming aan de achterkant (weekend)": false,
    "15:30 Broodtoaster aan (weekend)": false,
    "15:35 Friteuse 1/3 aan (weekend)": false,
    "15:50 Kassatellen (weekend)": false,
    "15:55 Tv‚Äôs aanzetten (weekend)": false,
    "16:00 Friteuse 2/4 aan (weekend)": false,
    "16:00 Wraps Toaster aan op 50 (weekend)": false,
    "16:00 Bord omdraaien naar geopend! (weekend)": false,
  };

  const order = [
    "15:15 Afzuiging aan",
    "15:15 Fietsen buiten en Dweilen",
    "15:20 PC aan",
    "15:20 brood/ bacon uithalen (check aantal onderaan de pagina)",
    "15:25 Dresstafel klaarmaken",
    "15:25 Bin aan inclusief verwarming aan de achterkant",
    "15:30 Grill aan",
    "15:40 Broodtoaster aan",
    "15:50 Friteuse 1/3 aan",
    "15:50 Kassatellen",
    "15:55 Tv‚Äôs aanzetten",
    "16:00 Friteuse 2/4 aan",
    "16:00 Wraps Toaster aan op 50 graden",
    "16:00 Bord omdraaien naar geopend!",
    // Weekend
    "15:15 Afzuiging aan (weekend)",
    "15:15 Fietsen buiten en Dweilen (weekend)",
    "15:20 PC aan (weekend)",
    "15:20 brood/ bacon uithalen (weekend)",
    "15:20 Grill aan (weekend)",
    "15:25 Dresstafel klaarmaken (weekend)",
    "15:25 Bin aan inclusief verwarming aan de achterkant (weekend)",
    "15:30 Broodtoaster aan (weekend)",
    "15:35 Friteuse 1/3 aan (weekend)",
    "15:50 Kassatellen (weekend)",
    "15:55 Tv‚Äôs aanzetten (weekend)",
    "16:00 Friteuse 2/4 aan (weekend)",
    "16:00 Wraps Toaster aan op 50 (weekend)",
    "16:00 Bord omdraaien naar geopend! (weekend)",
  ];
  return { items, order };
}

/* ===== State + realtime ===== */
let dataMap = {};
let order   = [];
onSnapshot(doc(db,"lists",DOC_ID), snap=>{
  if (snap.exists()){
    const d=snap.data();
    dataMap=d.items||{};
    order=Array.isArray(d.order)? d.order.filter(k=>k in dataMap) : Object.keys(dataMap);
    Object.keys(dataMap).forEach(k=>{ if(!order.includes(k)) order.push(k); });
  } else {
    awaitHardSeed();
  }
  render();
});

/* ===== Persist helpers ===== */
async function save(p){ await setDoc(doc(db,"lists",DOC_ID), { ...(p||{}), updatedAt: serverTimestamp() }, { merge:true }); }
async function awaitHardSeed(){
  const s=getSeed();
  dataMap=s.items; order=s.order;
  await setDoc(doc(db,"lists",DOC_ID), { items:s.items, order:s.order, updatedAt: serverTimestamp() }, { merge:false });
}

/* ===== Buttons helper ===== */
function makeBtn(txt, title, onClick){
  const b = document.createElement("button");
  b.className = "btn";
  b.type = "button";
  b.title = title;
  b.textContent = txt;
  b.addEventListener("click", (e) => {
    e.preventDefault(); e.stopPropagation();
    if (typeof e.stopImmediatePropagation === "function") e.stopImmediatePropagation();
    onClick();
  }, {capture:true});
  return b;
}

/* ===== Render ===== */
function render(){
  ulDay.innerHTML=""; ulWeekend.innerHTML="";
  const isWeekend = k => k.includes("(weekend)");
  const firstW = order.findIndex(isWeekend);
  const dayKeys = (firstW === -1) ? order.slice() : order.slice(0, firstW);
  const wkKeys  = (firstW === -1) ? [] : order.slice(firstW);

  const hasWeekend = wkKeys.some(k=>k in dataMap);
  wkDivider.style.display = hasWeekend ? "" : "none";
  wkHead.style.display    = hasWeekend ? "" : "none";

  const renderList = (keys, ul) => {
    keys.forEach((key)=>{
      if (!(key in dataMap)) return;
      const idx = order.indexOf(key);
      const li=document.createElement("li");
      li.className="item"+(dataMap[key]?" done":"");
      li.dataset.index=String(idx);

      const cb=document.createElement("input");
      cb.type="checkbox"; cb.checked=!!dataMap[key];
      cb.onchange = ()=> toggle(key);

      const span=document.createElement("div");
      span.className="label"; span.textContent=key;
      if (!canEdit) span.onclick = () => toggle(key);

      if (canEdit){
        const pen  = makeBtn("‚úèÔ∏è","Naam aanpassen",()=>renameItem(key));
        const del  = makeBtn("üóëÔ∏è","Verwijderen",()=>removeItemConfirm(key));

        // drag
        li.draggable = true;
        li.addEventListener("dragstart", e=>{
          li.classList.add("dragging");
          e.dataTransfer.setData("text/plain", String(idx));
        });
        li.addEventListener("dragend", ()=> li.classList.remove("dragging"));
        li.addEventListener("dragover", e=> e.preventDefault());
        li.addEventListener("drop", e=>{
          e.preventDefault();
          const from = Number(e.dataTransfer.getData("text/plain"));
          const to   = Number(li.dataset.index);
          if(Number.isFinite(from)&&Number.isFinite(to)&&from!==to){
            const next = order.slice();
            const [m] = next.splice(from,1);
            next.splice(to,0,m);
            order = next;
            save({order}); render();
          }
        });

        li.append(cb, span, pen, del);
      } else {
        li.append(cb, span);
      }
      ul.appendChild(li);
    });
  };

  renderList(dayKeys, ulDay);
  renderList(wkKeys,  ulWeekend);
  updateUI();
}

/* ===== Actions ===== */
function toggle(key){
  const next = { ...dataMap, [key]: !dataMap[key] };
  dataMap = next;
  save({ items: next });
}
function addItem(t){
  if(!canEdit) return;
  const x=(t||"").trim(); if(!x) return;
  if(x in dataMap){ alert("Bestaat al."); return; }
  const nextMap = { ...dataMap, [x]: false };
  const nextOrd = order.concat(x);
  dataMap = nextMap; order = nextOrd;
  render(); save({ items: nextMap, order: nextOrd });
}
async function removeItemConfirm(key){
  if(!canEdit) return;
  if(!(key in dataMap)) return;
  if(!confirm(`Verwijder "${key}"?`)) return;

  const nextMap = { ...dataMap }; 
  delete nextMap[key];
  const nextOrd = order.filter(k=>k!==key);
  dataMap = nextMap; order = nextOrd;
  render();

  await updateDoc(doc(db,"lists",DOC_ID), {
    [`items.${key}`]: deleteField(),
    order: nextOrd,
    updatedAt: serverTimestamp()
  });
}
async function renameItem(oldKey){
  if (!canEdit || !(oldKey in dataMap)) return;
  const s = prompt("Nieuwe naam:", oldKey.replace(/\s*\(weekend\)\s*$/i,'').trim());
  if (s === null) return;
  const newName = (s || "").trim();
  if (!newName) return;

  // als nieuwe naam al bestaat ‚Üí samenvoegen (OR van vinkjes)
  const exists = (newName in dataMap);
  const newValue = exists ? (!!dataMap[oldKey] || !!dataMap[newName]) : !!dataMap[oldKey];

  // lokale state
  let nextItems = { ...dataMap };
  delete nextItems[oldKey];
  nextItems[newName] = newValue;
  let nextOrder = order
    .filter(k => k !== oldKey)
    .map(k => k === oldKey ? newName : k);
  if (exists) {
    // laat volgorde van bestaande key staan
    nextOrder = order.filter(k => k !== oldKey);
  }

  dataMap = nextItems;
  order   = nextOrder;
  render();

  // Firestore: atomaire delete oude key + set nieuwe key + order
  await updateDoc(doc(db,"lists",DOC_ID), {
    [`items.${oldKey}`]: deleteField(),
    [`items.${newName}`]: newValue,
    order: nextOrder,
    updatedAt: serverTimestamp()
  });
}

/* ===== UI state ===== */
function updateUI(){
  [elNew, btnAdd].forEach(el=>{
    if(!el) return;
    el.disabled = !canEdit;
    el.style.opacity = canEdit ? 1 : .6;
    el.style.pointerEvents = canEdit ? "auto" : "none";
  });
  btnReset.disabled = false; btnReset.style.opacity = 1;
  btnSeed.disabled  = !canEdit; btnSeed.style.opacity = canEdit ? 1 : .5;
}

/* ===== Events ===== */
btnAdd.onclick = ()=>{ addItem(elNew.value); elNew.value=""; elNew.focus(); };
elNew.addEventListener("keydown", e=>{ if(e.key==="Enter"){ e.preventDefault(); addItem(elNew.value); elNew.value=""; }});

btnReset.onclick = ()=>{
  const next = Object.fromEntries(Object.keys(dataMap).map(k=>[k,false]));
  dataMap = next;
  save({ items: next });
};
btnSeed.onclick = async ()=>{
  if(!canEdit) return;
  if(!confirm("Herstel naar begin-lijst? (Iedereen ziet dit)")) return;
  await awaitHardSeed();
};
</script>
</body>
</html>
