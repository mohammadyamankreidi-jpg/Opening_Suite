<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ShiftStart â€“ Start</title>
  <style>
    :root{
      --red:#a31212;--black:#0b0b0f;--panel:rgba(21,25,34,.86);
      --line:#2a2f3a;--text:#eef2f8;--muted:#9fb0cb;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0;
      background:linear-gradient(90deg,var(--black) 50%,var(--red) 50%);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    }
    .wrap{max-width:980px;margin:0 auto;padding:28px 18px 40px}
    .card{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:16px;
      padding:20px;
      backdrop-filter:blur(6px);
    }
    header.panel{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
      padding:14px 16px;
      margin-bottom:12px;
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:14px
    }
    .brand{display:flex;flex-direction:column;gap:2px}
    .brand .h{font-weight:800;font-size:18px}
    .brand .s{color:var(--muted);font-size:12px}
    button{
      background:#101624;
      color:var(--text);
      border:1px solid var(--line);
      border-radius:10px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:600;
    }
    .add{
      display:grid;
      grid-template-columns:1fr 1fr auto;
      gap:10px;
      margin:8px 0 4px;
    }
    input[type="text"]{
      width:100%;
      padding:12px 14px;
      border-radius:10px;
      border:1px solid var(--line);
      background:#0b0f18;
      color:var(--text);
    }
    ul{
      list-style:none;
      padding:0;
      margin:0;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    li.item{
      display:flex;
      align-items:center;
      gap:10px;
      background:#0f1320;
      border:1px solid #262c39;
      border-radius:12px;
      padding:12px 14px;
    }
    a.label{
      flex:1;
      color:#d8e6ff;
      text-decoration:none;
    }
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:28px;
      height:28px;
      border:1px solid #444;
      border-radius:6px;
      background:#151a23;
      cursor:pointer;
      opacity:.95;
    }
    li.item.dragging{opacity:.6;outline:1px dashed #6aa0ff}
    .hint{color:var(--muted);font-size:12px;margin:6px 2px 0}
    footer.note{margin-top:12px;color:var(--muted);font-size:12px;text-align:center}

    .header-right{
      display:flex;
      align-items:center;
      gap:8px;
    }

    /* tools standaard onzichtbaar, alleen Back Office zichtbaar */
    .tools{
      display:none;
      gap:8px;
      flex-wrap:wrap;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="panel card">
      <div class="brand">
        <div class="h">ShiftStart</div>
        <div class="s">Kies een lijst</div>
      </div>

      <!-- Rechterkant: Back Office + verborgen tools -->
      <div class="header-right">
        <button id="btnBackoffice" type="button">Back Office</button>
        <div class="tools"></div>
      </div>
    </header>

    <div class="card">
      <div class="add">
        <input id="newTitle" type="text" placeholder="Knopnaam (bv. Prioriteit)" />
        <input id="newHref"  type="text" placeholder="Link (bv. prioriteit.html)" />
        <button id="btnAdd">Toevoegen</button>
      </div>
      <ul id="pages"></ul>
      <p class="hint">
        Zonder Back Office kun je alleen lijsten openen.  
        In bewerk-modus kun je toevoegen, hernoemen, verwijderen en slepen.
      </p>
    </div>

    <footer class="note">ShiftStart Â· gedeelde opslag via Firebase</footer>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
import { firebaseConfig } from "./firebase-config.js?v=15";

/* ===== Firebase ===== */
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

/* ===== Config ===== */
const HOME_ID     = "home_links";
const ADMIN_CODE  = "Yali313";
const LS_EDIT     = "editMode";
const LS_BACK     = "backoffice_unlocked";

/* ===== UI refs ===== */
const elTitle       = document.getElementById("newTitle");
const elHref        = document.getElementById("newHref");
const btnAdd        = document.getElementById("btnAdd");
const list          = document.getElementById("pages");
const btnBackoffice = document.getElementById("btnBackoffice");
const toolsBar      = document.querySelector(".tools");

/* ===== Tools in de header (maar nog niet zichtbaar) ===== */
const btnEdit = document.createElement("button");
btnEdit.type = "button";
btnEdit.textContent = "ðŸ”“ Bewerk-modus";

const btnView = document.createElement("button");
btnView.type = "button";
btnView.textContent = "ðŸ”’ Alleen bekijken";

toolsBar.replaceChildren(btnEdit, btnView);

/* ===== State ===== */
let pages = [];
let backUnlocked = (localStorage.getItem(LS_BACK) === "1");
let canEdit      = (localStorage.getItem(LS_EDIT) === "1");

/* ===== Helpers ===== */
function normaliseerLink(h, t){
  let v = (h||"").trim();
  if (!v){
    v = (t||"").trim()
      .toLowerCase()
      .replace(/[^a-z0-9]+/g,"-")
      .replace(/^-+|-+$/g,"") + ".html";
  }
  if (!/\.(html|htm)$/i.test(v)) v += ".html";
  return v;
}

async function save(){
  await setDoc(
    doc(db,"lists",HOME_ID),
    { pages, updatedAt: serverTimestamp() },
    { merge:true }
  );
}

async function load(){
  const snap = await getDoc(doc(db,"lists",HOME_ID));
  if (snap.exists()){
    const d = snap.data();
    pages = Array.isArray(d.pages) ? d.pages : [];
  } else {
    // standaard knoppen
    pages = [
      { t:"Prioriteit",        h:"prioriteit.html" },
      { t:"Voorraad & Checks", h:"voorraad_checks.html" },
      { t:"Schoonmaak klussen",h:"schoonmaak_klussen.html" },
      { t:"Eigen invoer",      h:"eigen_invoer.html" },
      { t:"Opslag",            h:"opslag.html" }
    ];
    await save();
  }
  render();
}

function makeIconButton(txt, title, onClick){
  const b = document.createElement("button");
  b.className = "btn";
  b.type = "button";
  b.textContent = txt;
  b.title = title;
  b.addEventListener("click",(e)=>{
    e.preventDefault();
    e.stopPropagation();
    e.stopImmediatePropagation?.();
    onClick();
  }, {capture:true});
  return b;
}

/* ===== UI state ===== */
function updateToolsVisible(){
  // Alleen tools tonen als Back Office ontgrendeld is
  toolsBar.style.display = backUnlocked ? "flex" : "none";
}

function updateUI(){
  [elTitle, elHref, btnAdd].forEach(el=>{
    if (!el) return;
    el.disabled = !canEdit;
    el.style.opacity = canEdit ? 1 : 0.6;
    el.style.pointerEvents = canEdit ? "auto" : "none";
  });
  // Edit-iconen per regel
  [...list.querySelectorAll(".btn")].forEach(b=>{
    b.style.display = canEdit ? "inline-flex" : "none";
  });
}

/* ===== Render ===== */
function render(){
  list.innerHTML = "";
  pages.forEach((p, idx)=>{
    const li = document.createElement("li");
    li.className = "item";
    li.dataset.index = String(idx);

    const a = document.createElement("a");
    a.className = "label";
    a.href = p.h;
    a.textContent = p.t;

    if (canEdit){
      const pen = makeIconButton("âœï¸","Naam aanpassen",()=>{
        const s = prompt("Nieuwe naam:", p.t);
        if (s === null) return;
        const t = s.trim();
        if (!t) return;
        if (pages.some((x,i)=> i!==idx && x.t.toLowerCase()===t.toLowerCase())){
          alert("Naam bestaat al.");
          return;
        }
        pages[idx] = { t, h: normaliseerLink(p.h, t) };
        save().then(render);
      });

      const trash = makeIconButton("ðŸ—‘ï¸","Verwijderen",()=>{
        if (!confirm(`Verwijder "${p.t}"?`)) return;
        pages = pages.filter((_,i)=>i!==idx);
        save().then(render);
      });

      li.draggable = true;
      li.addEventListener("dragstart", e=>{
        li.classList.add("dragging");
        e.dataTransfer.setData("text/plain", String(idx));
      });
      li.addEventListener("dragend", ()=> li.classList.remove("dragging"));
      li.addEventListener("dragover", e=> e.preventDefault());
      li.addEventListener("drop", e=>{
        e.preventDefault();
        const from = Number(e.dataTransfer.getData("text/plain"));
        const to   = Number(li.dataset.index);
        if (Number.isFinite(from) && Number.isFinite(to) && from !== to){
          const next = pages.slice();
          const [moved] = next.splice(from,1);
          next.splice(to,0,moved);
          pages = next;
          save().then(render);
        }
      });

      li.append(a, pen, trash);
    } else {
      li.append(a);
    }

    list.appendChild(li);
  });

  updateUI();
}

/* ===== Back Office met sterretjes ===== */
btnBackoffice.onclick = () => {
  // Pop-up met password veld
  const modal = document.createElement("div");
  Object.assign(modal.style,{
    position:"fixed",
    inset:"0",
    background:"rgba(0,0,0,0.6)",
    display:"flex",
    alignItems:"center",
    justifyContent:"center",
    zIndex:"9999"
  });

  const box = document.createElement("div");
  Object.assign(box.style,{
    background:"#141824",
    padding:"20px",
    borderRadius:"12px",
    boxShadow:"0 0 15px rgba(0,0,0,0.5)",
    textAlign:"center",
    width:"260px"
  });

  const label = document.createElement("div");
  label.textContent = "Voer beheerderscode in:";
  label.style.marginBottom = "10px";

  const input = document.createElement("input");
  input.type = "password";       // â­ sterretjes
  input.placeholder = "â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢";
  Object.assign(input.style,{
    width:"100%",
    padding:"10px",
    borderRadius:"8px",
    border:"1px solid #333",
    background:"#0b0f18",
    color:"#fff",
    marginBottom:"12px"
  });

  const ok = document.createElement("button");
  ok.textContent = "Ontgrendel";
  Object.assign(ok.style,{
    background:"#1c2333",
    color:"#fff",
    border:"1px solid #444",
    borderRadius:"8px",
    padding:"8px 14px",
    cursor:"pointer"
  });

  const cancel = document.createElement("button");
  cancel.textContent = "Annuleren";
  Object.assign(cancel.style,{
    marginLeft:"8px",
    background:"#333",
    color:"#ccc",
    border:"1px solid #555",
    borderRadius:"8px",
    padding:"8px 14px",
    cursor:"pointer"
  });

  box.append(label, input, ok, cancel);
  modal.append(box);
  document.body.append(modal);
  input.focus();

  function closeModal(){ modal.remove(); }

  ok.onclick = () => {
    const code = input.value.trim();
    if (code === ADMIN_CODE){
      backUnlocked = true;
      canEdit = true;
      localStorage.setItem(LS_BACK,"1");
      localStorage.setItem(LS_EDIT,"1");
      updateToolsVisible();
      updateUI();
      closeModal();
      alert("Back Office geopend âœ… (Bewerk-modus aan)");
      render();
    } else {
      alert("Onjuiste code");
      input.value = "";
      input.focus();
    }
  };

  cancel.onclick = closeModal;
};

/* ===== Knoppen in de tools-bar ===== */
btnEdit.onclick = () => {
  // Vanuit Back Office mag dit zonder opnieuw code
  if (!backUnlocked){
    alert("Eerst Back Office openen.");
    return;
  }
  canEdit = true;
  localStorage.setItem(LS_EDIT,"1");
  updateUI();
  render();
  alert("Bewerk-modus aan âœ…");
};

btnView.onclick = () => {
  canEdit = false;
  localStorage.removeItem(LS_EDIT);
  updateUI();
  render();
  alert("Alleen bekijken ðŸ”’");
};

/* ===== Events ===== */
btnAdd.onclick = async () => {
  if (!canEdit) return;
  const t = elTitle.value.trim();
  const h = elHref.value.trim();
  if (!t) return alert("Geef minimaal een naam.");
  if (pages.some(p=>p.t.toLowerCase()===t.toLowerCase())){
    return alert("Naam bestaat al.");
  }
  pages = pages.concat({ t, h: normaliseerLink(h, t) });
  elTitle.value = "";
  elHref.value  = "";
  elTitle.focus();
  await save();
  render();
};

// luister naar veranderingen in andere tabbladen
window.addEventListener("storage", e=>{
  if (e.key === LS_EDIT){
    canEdit = (localStorage.getItem(LS_EDIT) === "1");
    updateUI();
    render();
  }
  if (e.key === LS_BACK){
    backUnlocked = (localStorage.getItem(LS_BACK) === "1");
    updateToolsVisible();
  }
});

/* ===== Init ===== */
updateToolsVisible();
await load();
updateUI();
</script>
</body>
</html>
