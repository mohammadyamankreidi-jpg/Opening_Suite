<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ShiftStart ‚Äì Eigen invoer</title>
  <link rel="icon" href="data:,">
  <style>
    :root{--red:#a31212;--black:#0b0b0f;--panel:rgba(21,25,34,.86);--line:#2a2f3a;--text:#eef2f8;--muted:#9fb0cb}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:linear-gradient(90deg,var(--black) 50%,var(--red) 50%);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:980px;margin:0 auto;padding:28px 18px 40px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:20px;backdrop-filter:blur(6px)}
    header.panel{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;padding:14px 16px;margin-bottom:12px;background:var(--panel);border:1px solid var(--line);border-radius:14px}
    .brand .h{font-weight:800;font-size:18px}.brand .s{color:var(--muted);font-size:12px}
    .tools{display:flex;gap:8px;flex-wrap:wrap}
    button{background:#101624;color:var(--text);border:1px solid var(--line);border-radius:10px;padding:10px 12px;cursor:pointer;font-weight:600}
    .add{display:grid;grid-template-columns:1fr auto;gap:10px;margin:8px 0 4px}
    input[type="text"]{width:100%;padding:12px 14px;border-radius:10px;border:1px solid var(--line);background:#0b0f18;color:var(--text)}
    ul{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:8px}
    li.item{display:flex;align-items:center;gap:8px;background:#0f1320;border:1px solid #262c39;border-radius:12px;padding:12px 14px}
    li.item.done{opacity:.6;text-decoration:line-through}
    .label{flex:1;cursor:pointer}
    .btn{display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border:1px solid #444;border-radius:6px;background:#151a23;cursor:pointer;opacity:.95}
    li.item.dragging{opacity:.6;outline:1px dashed #6aa0ff}
    .nav{display:flex;gap:10px;margin-bottom:12px}.nav a{color:#d8e6ff}
    .hint{color:var(--muted);font-size:12px;margin:6px 2px 0}
    footer.note{margin-top:12px;color:var(--muted);font-size:12px;text-align:center}
  </style>
</head>
<body>
  <div class="wrap">
    <nav class="nav"><a href="index.html">‚Üê Terug</a></nav>

    <header class="panel card">
      <div class="brand">
        <div class="h">ShiftStart</div>
        <div class="s">Eigen invoer</div>
      </div>
      <div class="tools"></div>
    </header>

    <div class="card">
      <div class="add">
        <input id="newItem" type="text" placeholder="Nieuw item toevoegen..." />
        <button id="btnAdd">Toevoegen</button>
      </div>
      <ul id="list"></ul>
      <p class="hint">Klik op de tekst of het vinkje om af te strepen. Alles synchroniseert realtime.</p>
    </div>

    <footer class="note">ShiftStart ¬∑ gedeelde opslag via Firebase</footer>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
import { getFirestore, doc, onSnapshot, setDoc, serverTimestamp, updateDoc, deleteField } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
import { firebaseConfig } from "./firebase-config.js?v=15";

/* ===== Firebase ===== */
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

/* ===== Config ===== */
const DOC_ID = "eigen_invoer"; // eigen document-id

/* ===== UI refs ===== */
const elList = document.getElementById("list");
const elNew  = document.getElementById("newItem");
const btnAdd = document.getElementById("btnAdd");

/* ===== Toolbar ===== */
let tools = document.querySelector(".tools");
const bReset = document.createElement("button"); bReset.type="button"; bReset.textContent = "Alles herstellen";
const bSeed  = document.createElement("button"); bSeed.type="button";  bSeed.textContent  = "Herstel lijst";
tools.replaceChildren(bReset, bSeed);

/* ===== Seed (LEEG) ===== */
function getSeed(){
  const items = { };              // volledig schoon
  const order = [];               // geen volgorde
  return { items, order };
}

/* ===== State + realtime ===== */
let items = {}, order = [];
onSnapshot(doc(db,"lists",DOC_ID), async snap=>{
  if (snap.exists()){
    const d = snap.data();
    items = d.items || {};
    order = Array.isArray(d.order) ? d.order.filter(k=>k in items) : Object.keys(items);
    Object.keys(items).forEach(k=>{ if(!order.includes(k)) order.push(k); });
  } else {
    const s = getSeed();
    items = s.items; order = s.order;
    await setDoc(doc(db,"lists",DOC_ID), { items:s.items, order:s.order, updatedAt: serverTimestamp() }, { merge:false });
  }
  render();
});

/* ===== Persist helper ===== */
async function save(p){
  await setDoc(doc(db,"lists",DOC_ID), { ...(p||{}), updatedAt: serverTimestamp() }, { merge:true });
}

/* ===== UI helper ===== */
function btn(txt,title,onClick){
  const b = document.createElement("button");
  b.className = "btn"; b.textContent = txt; b.title = title; b.type="button";
  b.addEventListener("click",(e)=>{
    e.preventDefault(); e.stopPropagation();
    if (typeof e.stopImmediatePropagation==="function") e.stopImmediatePropagation();
    onClick();
  }, {capture:true});
  return b;
}

/* ===== Render ===== */
function render(){
  elList.innerHTML="";
  const keys = order.length ? order.slice() : Object.keys(items);

  keys.forEach((k,idx)=>{
    if(!(k in items)) return;

    const li = document.createElement("li");
    li.className = "item"+(items[k]?" done":"");
    li.dataset.index = String(idx);

    const cb = document.createElement("input");
    cb.type = "checkbox"; cb.checked = !!items[k];
    cb.onchange = ()=> toggle(k);

    const label = document.createElement("div");
    label.className = "label";
    label.textContent = k;
    label.onclick = ()=> toggle(k);

    // acties (iedereen mag bewerken op Eigen invoer)
    const pen = btn("‚úèÔ∏è","Naam aanpassen",()=>renameItem(k));
    const del = btn("üóëÔ∏è","Verwijderen",()=>removeItemConfirm(k));

    // drag & drop
    li.draggable = true;
    li.addEventListener("dragstart", e=>{
      li.classList.add("dragging");
      e.dataTransfer.setData("text/plain", String(idx));
    });
    li.addEventListener("dragend", ()=> li.classList.remove("dragging"));
    li.addEventListener("dragover", e=> e.preventDefault());
    li.addEventListener("drop", e=>{
      e.preventDefault();
      const from = Number(e.dataTransfer.getData("text/plain"));
      const to   = Number(li.dataset.index);
      if(Number.isFinite(from)&&Number.isFinite(to)&&from!==to){
        const next = order.slice();
        const [moved] = next.splice(from,1);
        next.splice(to,0,moved);
        order = next;
        save({order});
        render();
      }
    });

    li.append(cb,label,pen,del);
    elList.appendChild(li);
  });
}

/* ===== Actions ===== */
function toggle(k){
  const next = { ...items, [k]: !items[k] };
  items = next;
  save({ items: next });
}

function addItem(t){
  const x = (t || "").trim();
  if(!x) return;
  if(x in items){ alert("Bestaat al."); return; }
  const next = { ...items, [x]: false };
  const nextOrder = order.concat(x);
  items = next; order = nextOrder;
  render();
  save({ items: next, order: nextOrder });
}

async function removeItemConfirm(k){
  if(!(k in items)) return;
  if(!confirm(`Verwijder "${k}"?`)) return;

  // lokaal
  const next = { ...items }; delete next[k];
  const nextOrder = order.filter(x=>x!==k);
  items = next; order = nextOrder;
  render();

  // Firestore veld echt verwijderen
  await updateDoc(doc(db,"lists",DOC_ID),{
    [`items.${k}`]: deleteField(),
    order: nextOrder,
    updatedAt: serverTimestamp()
  });
}

async function renameItem(oldK){
  if(!(oldK in items)) return;
  const s = prompt("Nieuwe naam:", oldK);
  if (s===null) return;
  const n = (s||"").trim();
  if(!n) return;
  if(n === oldK) return;

  const exists = (n in items);
  const merged = !!items[oldK] || !!items[n];

  // lokaal
  let nextItems = { ...items };
  let nextOrder = order.slice();

  if (exists){
    nextItems[n] = merged;
    delete nextItems[oldK];
    nextOrder = nextOrder.filter(k => k !== oldK); // positie van bestaande n behouden
  } else {
    nextItems[n] = !!nextItems[oldK];
    delete nextItems[oldK];
    nextOrder = nextOrder.map(k => k === oldK ? n : k);
  }

  items = nextItems; order = nextOrder;
  render();

  // Firestore
  await updateDoc(doc(db,"lists",DOC_ID),{
    [`items.${oldK}`]: deleteField(),
    [`items.${n}`]: merged,
    order: nextOrder,
    updatedAt: serverTimestamp()
  });
}

/* ===== Events ===== */
btnAdd.onclick = ()=>{ addItem(elNew.value); elNew.value=""; elNew.focus(); };
elNew.addEventListener("keydown", e=>{
  if(e.key==="Enter"){ e.preventDefault(); addItem(elNew.value); elNew.value=""; }
});

bReset.onclick = ()=>{
  // alleen alle vinkjes uit (structuur blijft)
  const next = Object.fromEntries(Object.keys(items).map(k=>[k,false]));
  items = next;
  save({ items: next });
};

bSeed.onclick  = async ()=>{
  // volledig terug naar begin (LEEG) ‚Äì alle oude rommel weg
  if(!confirm("Herstel naar begin-lijst (leeg)? (Iedereen ziet dit)")) return;
  const s = getSeed();
  items = s.items; order = s.order;
  await setDoc(doc(db,"lists",DOC_ID), { items:s.items, order:s.order, updatedAt: serverTimestamp() }, { merge:false });
  render();
};
</script>
</body>
</html>
