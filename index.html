<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ShiftStart – Start</title>
  <style>
    :root{--red:#a31212;--black:#0b0b0f;--panel:rgba(21,25,34,.86);--line:#2a2f3a;--text:#eef2f8;--muted:#9fb0cb}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:linear-gradient(90deg,var(--black) 50%,var(--red) 50%);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:900px;margin:0 auto;padding:28px 18px 40px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:20px;backdrop-filter:blur(6px)}
    header.panel{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;padding:14px 16px;margin-bottom:12px;background:var(--panel);border:1px solid var(--line);border-radius:14px}
    .brand{display:flex;flex-direction:column;gap:2px}.brand .h{font-weight:800;font-size:18px}.brand .s{color:var(--muted);font-size:12px}
    .tools{display:flex;gap:8px;flex-wrap:wrap}
    button{background:#101624;color:var(--text);border:1px solid var(--line);border-radius:10px;padding:10px 12px;cursor:pointer;font-weight:600}
    ul{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:10px}
    li.item{display:flex;align-items:center;gap:10px;background:#111722;border:1px solid #2a2f3a;border-radius:12px;padding:14px}
    li.item .label{flex:1;color:var(--text);text-decoration:none;font-weight:700}
    li.item .trash{display:none;align-items:center;justify-content:center;width:28px;height:28px;border:1px solid #444;border-radius:6px;background:#151a23;cursor:pointer;opacity:.85}
    li.item.dragging{opacity:.6;outline:1px dashed #6aa0ff}
    .add{display:none;grid-template-columns:1fr auto;gap:10px;margin-top:12px}
    input[type="text"]{width:100%;padding:12px 14px;border-radius:10px;border:1px solid var(--line);background:#0b0f18;color:var(--text)}
    footer.note{margin-top:20px;color:var(--muted);font-size:12px;text-align:center}
    .hint{color:#9fb0cb;font-size:12px;margin-top:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="panel card">
      <div class="brand"><div class="h">ShiftStart</div><div class="s">Startpagina</div></div>
      <div class="tools">
        <button id="btnEdit">🔓 Bewerk-modus</button>
        <button id="btnView">🔒 Alleen bekijken</button>
      </div>
    </header>

    <div class="card">
      <!-- ✅ Statische fallback die altijd zichtbaar is -->
      <ul id="list">
        <li class="item"><a class="label" href="prioriteit.html">Prioriteit</a><button class="trash">🗑️</button></li>
        <li class="item"><a class="label" href="voorraad_checks.html">Voorraad & Checks</a><button class="trash">🗑️</button></li>
        <li class="item"><a class="label" href="schoonmaak_klussen.html">Schoonmaak klussen</a><button class="trash">🗑️</button></li>
      </ul>

      <!-- verschijnt pas als Firebase werkt en jij ingelogd bent -->
      <div class="add" id="addBar">
        <input id="newItem" type="text" placeholder="Nieuwe knop (naam)..." />
        <button id="btnAdd">Toevoegen</button>
      </div>

      <p class="hint">🔐 Toevoegen/verwijderen/slepen kan na inloggen met 🔓 Bewerk-modus.</p>
    </div>

    <footer class="note">ShiftStart · gedeelde opslag via Firebase</footer>
  </div>

<script type="module">
const elList  = document.getElementById("list");
const addBar  = document.getElementById("addBar");
const elNew   = document.getElementById("newItem");
const btnAdd  = document.getElementById("btnAdd");
const btnEdit = document.getElementById("btnEdit");
const btnView = document.getElementById("btnView");

let canEdit = false;
let pages   = null; // null = nog geen Firestore, object = Firestore actief
let auth, db, signInAnonymously, signInWithEmailAndPassword, onAuthStateChanged, signOut, doc, onSnapshot, setDoc, serverTimestamp;

// Helpers
function setEditMode(enabled){
  canEdit = enabled;
  // show/hide controls
  addBar.style.display = (pages && canEdit) ? "grid" : "none";
  document.querySelectorAll(".trash").forEach(btn=>{
    btn.style.display = (pages && canEdit) ? "inline-flex" : "none";
  });
  // make items draggable only when edit + pages
  Array.from(elList.children).forEach((li, idx)=>{
    li.draggable = !!(pages && canEdit);
    if (pages && canEdit) {
      li.addEventListener("dragstart", e => { li.classList.add("dragging"); e.dataTransfer.setData("text/plain", String(idx)); });
      li.addEventListener("dragend",   () => li.classList.remove("dragging"));
      li.addEventListener("dragover",  e => e.preventDefault());
      li.addEventListener("drop", e => {
        e.preventDefault();
        const from = Number(e.dataTransfer.getData("text/plain"));
        const to   = Array.from(elList.children).indexOf(li);
        if (!pages || !Number.isFinite(from) || !Number.isFinite(to) || from===to) return;
        const keys = Object.keys(pages);
        const [moved] = keys.splice(from,1);
        keys.splice(to,0,moved);
        const reordered = {};
        keys.forEach(k => reordered[k] = pages[k]);
        savePages(reordered);
      });
    }
  });
}
function renderFromObject(obj){
  elList.innerHTML = "";
  Object.entries(obj).forEach(([name, href])=>{
    const li = document.createElement("li");
    li.className = "item";
    const a = document.createElement("a");
    a.className = "label"; a.href = href; a.textContent = name;
    const trash = document.createElement("button");
    trash.className = "trash"; trash.textContent = "🗑️";
    trash.onclick = ()=>{ if (!pages || !canEdit) return; const next = {...pages}; delete next[name]; savePages(next); };
    li.append(a, trash);
    elList.appendChild(li);
  });
  setEditMode(canEdit);
}
function currentDomAsObject(){
  const out = {};
  Array.from(elList.querySelectorAll("li")).forEach(li=>{
    const a = li.querySelector("a.label");
    if (a) out[a.textContent.trim()] = a.getAttribute("href");
  });
  return out;
}
async function savePages(newObj){
  if (!db) return;
  const { doc, setDoc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js");
  await setDoc(doc(db,"lists","shiftstart_home"), { pages:newObj, updatedAt: serverTimestamp() }, { merge:true });
}

// Boot: probeer Firebase dynamisch. Als het faalt → we houden de fallback zichtbaar.
(async ()=>{
  try {
    const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js");
    const firestore = await import("https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js");
    const authmod   = await import("https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js");
    const { firebaseConfig } = await import("./firebase-config.js?v=15");

    ({ doc, onSnapshot, setDoc, serverTimestamp } = firestore);
    ({ getAuth: (g)=>auth=g(), signInAnonymously, signInWithEmailAndPassword, onAuthStateChanged, signOut } = { 
      getAuth: authmod.getAuth, 
      signInAnonymously: authmod.signInAnonymously,
      signInWithEmailAndPassword: authmod.signInWithEmailAndPassword,
      onAuthStateChanged: authmod.onAuthStateChanged,
      signOut: authmod.signOut
    });

    const app = initializeApp(firebaseConfig);
    const { getFirestore } = firestore;
    db = getFirestore(app);

    // Auth: anoniem default
    try { await signInAnonymously(auth); } catch(e){}

    // Realtime home-links
    onSnapshot(doc(db,"lists","shiftstart_home"), snap=>{
      if (snap.exists()) {
        pages = snap.data().pages || {};
        if (Object.keys(pages).length === 0) {
          // Als leeg: initialiseer vanuit DOM
          pages = currentDomAsObject();
          savePages(pages);
        }
        renderFromObject(pages);
      } else {
        pages = currentDomAsObject(); // pak de fallback en maak doc aan zodra user toevoegt
        renderFromObject(pages);
      }
    });

    // Slot knoppen
    btnEdit.onclick = async ()=>{
      const email = prompt("Email:");
      const pwd   = prompt("Wachtwoord:");
      if (!email || !pwd) return;
      try { await signOut(auth); await signInWithEmailAndPassword(auth,email,pwd); setEditMode(true); alert("Bewerk-modus aan ✅"); }
      catch(e){ alert("Inloggen mislukt: " + (e.code || e.message)); }
    };
    btnView.onclick = async ()=>{
      try { await signOut(auth);} catch(e){}
      await signInAnonymously(auth);
      setEditMode(false);
      alert("Alleen bekijken 🔒");
    };

    // Voeg toe
    btnAdd.onclick = ()=>{
      if (!pages) return; // nog geen firebase ready
      if (!canEdit) return;
      const name = (elNew.value||"").trim();
      if (!name) return;
      const file = name.toLowerCase().replace(/\s+/g,"_") + ".html";
      const next = { ...pages, [name]: file };
      savePages(next);
      elNew.value = "";
    };

    // update UI bij auth wissel
    onAuthStateChanged(auth, user => {
      setEditMode(!!user && !!user.email);
    });

  } catch (e) {
    // Firebase faalde -> laat fallback staan, disable edit
    setEditMode(false);
  }
})();
</script>
</body>
</html>
